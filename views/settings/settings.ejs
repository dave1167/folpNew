<!-- Wappler include head-page="layouts/lh_menu" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="settings" appConnect="local" components="{dmxDataTraversal:{},dmxBootstrap5Navigation:{},dmxBootstrap5Modal:{},dmxFlow:{},dmxBootstrap5TableGenerator:{}}" -->
<meta name="ac:route" content="/settings/settings">

<div class="container py-4">

    <!-- Server Connect: loads settings from tbl_settings via API action (/api/settings/list) -->
    <dmx-serverconnect id="settings_api" url="api/settings/list" noload></dmx-serverconnect>
    <dmx-serverconnect id="save_setting_api" url="api/settings/save" noload></dmx-serverconnect>

    <!-- Data detail to select a single setting (uses key as unique identifier) -->
    <dmx-data-detail id="selected_setting" dmx-bind:data="settings_api.data" key="settingKey"></dmx-data-detail>

    <!-- Ensure we load settings when App Connect is ready -->
    <div dmx-on:appconnect:ready="settings_api.load()" style="display:none"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">Settings</h1>
        <div>
            <button class="btn btn-outline-secondary me-2" dmx-on:click="settings_api.load()">Reload</button>
        </div>
    </div>

    <!-- Show errors from the API -->
    <div class="alert alert-danger" role="alert" dmx-show="settings_api.lastError">
        <strong>Error:</strong> <span dmx-text="settings_api.lastError.message"></span>
    </div>

    <!-- Tab navigation for settings sections -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#membership_tab" type="button" role="tab">Membership</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#versions_tab" type="button" role="tab">Versions</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#templates_tab" type="button" role="tab">Templates</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#general_tab" type="button" role="tab">General</button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- Membership section -->
        <div class="tab-pane fade show active" id="membership_tab" role="tabpanel">
            <dmx-data-view id="membership_view" dmx-bind:data="settings_api.data.settings" filter="section=='membership'"></dmx-data-view>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody is="dmx-repeat" dmx-generator="bs5table" dmx-bind:repeat="membership_view.data" id="tableRepeat1">
                        <tr>
                            <td dmx-text="settingKey"></td>
                            <td>
                                <pre class="mb-0 settings-code"><code dmx-text="value"></code></pre>
                            </td>
                            <td dmx-text="description"></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" dmx-on:click="selected_setting.select(settingKey); editModal.show()">
                                    Edit
                                </button>
                            </td>
                        </tr>

                    </tbody>
                </table>
            </div>
        </div>

        <!-- Versions section -->
        <div class="tab-pane fade" id="versions_tab" role="tabpanel">
            <dmx-data-view id="versions_view" dmx-bind:data="settings_api.data" filter="section == 'versions'"></dmx-data-view>
            <div class="table-responsive">
                <table class="table table-sm table-striped settings-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody is="dmx-repeat" id="versions_list" dmx-bind:repeat="versions_view.data">
                        <tr>
                            <td dmx-text="settingKey"></td>
                            <td>
                                <pre class="mb-0 settings-code"><code dmx-text="value"></code></pre>
                            </td>
                            <td dmx-text="description"></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" dmx-on:click="selected_setting.select(key); editModal.show()">Edit</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Templates section -->
        <div class="tab-pane fade" id="templates_tab" role="tabpanel">
            <dmx-data-view id="templates_view" dmx-bind:data="settings_api.data" filter="section == 'templates'"></dmx-data-view>
            <div class="table-responsive">
                <table class="table table-sm table-striped settings-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody is="dmx-repeat" id="templates_list" dmx-bind:repeat="templates_view.data">
                        <tr>
                            <td dmx-text="settingKey"></td>
                            <td>
                                <pre class="mb-0 settings-code"><code dmx-text="value"></code></pre>
                            </td>
                            <td dmx-text="description"></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" dmx-on:click="selected_setting.select(key); editModal.show()">Edit</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- General / other settings -->
        <div class="tab-pane fade" id="general_tab" role="tabpanel">
            <dmx-data-view id="general_view" dmx-bind:data="settings_api.data" filter="section != 'membership' &amp;&amp; section != 'versions' &amp;&amp; section != 'templates'"></dmx-data-view>
            <div class="table-responsive">
                <table class="table table-sm table-striped settings-table">
                    <thead>
                        <tr>
                            <th>Section</th>
                            <th>Key</th>
                            <th>Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody is="dmx-repeat" id="general_list" dmx-bind:repeat="general_view.data">
                        <tr>
                            <td dmx-text="section"></td>
                            <td dmx-text="settingKey"></td>
                            <td>
                                <pre class="mb-0 settings-code"><code dmx-text="value"></code></pre>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" dmx-on:click="selected_setting.select(key); editModal.show()">Edit</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Edit modal for a single setting -->
    <div class="modal fade" id="editModal" is="dmx-bs5-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Setting</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit_setting_form">
                        <div class="mb-3">
                            <label for="edit_key" class="form-label">Key</label>
                            <input type="text" id="edit_key" class="form-control" readonly dmx-bind:value="selected_setting.data.settingKey">
                        </div>
                        <div class="mb-3">
                            <label for="edit_section" class="form-label">Section</label>
                            <input type="text" id="edit_section" class="form-control" dmx-bind:value="selected_setting.data.section">
                        </div>
                        <div class="mb-3">
                            <label for="edit_value" class="form-label">Value</label>
                            <textarea id="edit_value" rows="6" class="form-control" dmx-bind:value="selected_setting.data.value"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit_description" class="form-label">Description</label>
                            <input type="text" id="edit_description" class="form-control" dmx-bind:value="selected_setting.data.description">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" dmx-on:click="
                    /* Update the selected_setting data object before running the flow */
                    selected_setting.data.value.setValue(edit_value.value);
                    selected_setting.data.section.setValue(edit_section.value);
                    selected_setting.data.description.setValue(edit_description.value);
                    edit_setting_flow.run()
                  " dmx-bind:disabled="edit_setting_flow.running">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline Page Flow to save a setting and reload the list -->
    <script is="dmx-flow" id="edit_setting_flow" type="text/dmx-flow" dmx-param:setting="selected_setting.data" dmx-on:done="editModal.hide(); settings_api.load()">
        {
    steps: [
      {
        name: "save",
        save_setting_api: {
          load: {
            key: "$param.setting.settingKey",
            value: "$param.setting.value",
            section: "$param.setting.section",
            description: "$param.setting.description"
          }
        }
      }
    ]
  }
  </script>

</div>